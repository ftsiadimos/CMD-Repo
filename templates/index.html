{% extends "layout.html" %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h1 class="mb-0"><i class="bi bi-terminal me-2"></i>All Commands</h1>
  <a href="{{ url_for('add') }}" class="btn btn-primary d-none d-md-inline-flex align-items-center">
    <i class="bi bi-plus-lg me-1"></i>Add Command
  </a>
</div>

<div class="card shadow-sm mb-4">
  <div class="card-body">
    <form class="row g-2 align-items-end" method="get" action="{{ url_for('index') }}">
      <div class="col-12 col-md-5 col-lg-4">
        <label for="search" class="form-label small text-muted mb-1">Search</label>
        <div class="input-group">
          <span class="input-group-text"><i class="bi bi-search"></i></span>
          <input type="text" id="search" name="search" class="form-control" 
                 placeholder="Search commands, descriptions, tags…" 
                 value="{{ search }}" list="tag-suggestions" autocomplete="off">
        </div>
        <datalist id="tag-suggestions">
          {% for tag in total_tags %}
            <option value="{{ tag }}">{{ tag }}</option>
          {% endfor %}
        </datalist>
      </div>
      <div class="col-6 col-md-3 col-lg-2">
        <label for="per_page" class="form-label small text-muted mb-1">Rows per page</label>
        <select id="per_page" name="per_page" class="form-select">
          <option value="5" {% if per_page|default(5)|int == 5 %}selected{% endif %}>5 rows</option>
          <option value="25" {% if per_page|default(5)|int == 25 %}selected{% endif %}>25 rows</option>
          <option value="50" {% if per_page|default(5)|int == 50 %}selected{% endif %}>50 rows</option>
          <option value="100" {% if per_page|default(5)|int == 100 %}selected{% endif %}>100 rows</option>
        </select>
      </div>
      <div class="col-6 col-md-2 col-lg-2">
        <button type="submit" class="btn btn-primary w-100">
          <i class="bi bi-filter me-1"></i>Apply
        </button>
      </div>
      {% if search %}
      <div class="col-auto">
        <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">
          <i class="bi bi-x-lg"></i> Clear
        </a>
      </div>
      {% endif %}
    </form>
  </div>
</div>

{% if commands %}
  <style>
      /* ---------- truncation utilities (unchanged) ---------- */
      .truncate-1,
      .truncate-2,
      .truncate-3 {
        display: block;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .truncate-1 { white-space: nowrap; }
      @supports (-webkit-line-clamp: 2) {
        .truncate-1 { white-space: normal; display: -webkit-box; line-clamp: 1; -webkit-line-clamp: 1; -webkit-box-orient: vertical; }
        .truncate-2 { display: -webkit-box; line-clamp: 2; -webkit-line-clamp: 2; -webkit-box-orient: vertical; }
        .truncate-3 { display: -webkit-box; line-clamp: 3; -webkit-line-clamp: 3; -webkit-box-orient: vertical; }
      }

      /* ---------- expanded row – remove truncation ---------- */
      tr.expanded .truncate-1,
      tr.expanded .truncate-2,
      tr.expanded .truncate-3 {
        white-space: normal !important;
        overflow: visible !important;
        text-overflow: unset !important;
        display: block !important;
        line-clamp: unset !important;
        -webkit-line-clamp: unset !important;
      }

      /* ---------- arrow indicator ---------- */
      .expand-arrow {
        display: inline-block;
        transition: transform 0.2s ease;
        font-size: 0.9rem;
        margin-right: 0.4rem;
      }
      tr.expanded .expand-arrow { transform: rotate(90deg); }

      /* ---------- command cell becomes a title when expanded ---------- */
      .cmd-cell { font-family: monospace; }
      tr.expanded .cmd-cell {
        white-space: pre-wrap !important;
      }
      tr.expanded .cmd-cell .truncate-2 {
        font-size: 1.1rem;
        font-weight: 600;
        display: block;
        margin-bottom: 0.4rem;
        white-space: pre-wrap !important;
        overflow: visible !important;
        text-overflow: unset !important;
        -webkit-line-clamp: unset !important;
        line-clamp: unset !important;
      }

      /* ---------- hide the other columns when expanded ---------- */
      tr.expanded td:not(.cmd-cell):not(.desc-cell):not(:first-child) {
        display: none;
      }

      /* ---------- description cell takes full width when expanded ---------- */
      tr.expanded .desc-cell {
        display: table-cell;
        width: 100%;
        padding-top: 0.4rem;
      }

      /* ---------- keep paragraphs & spaces in description ---------- */
      .description-text {
        white-space: pre-wrap;   /* preserves line‑breaks & multiple spaces */
        font-family: inherit;     /* keep same font as surrounding text */
        margin: 0;               /* remove default <pre> margin */
      }

      /* NEW: keep pre‑wrap even when the row is expanded */
      tr.expanded .description-text {
        white-space: pre-wrap !important;
      }

      /* ---------- copy button (unchanged) ---------- */
      .copy-btn {
        opacity: 0.9;
        transition: opacity 0.12s ease;
      }
      @media (max-width: 480px) {
        .copy-btn { opacity: 0.8; font-size: 0.72rem; padding: 0.2rem 0.4rem; }
      }

      /* ---------- table layout with min-widths ---------- */
      .cmd-table {
        width: 100%;
      }
      .cmd-table th, .cmd-table td {
        vertical-align: middle;
      }
      .cmd-table .col-arrow { width: 30px; }
      .cmd-table .col-cmd { min-width: 200px; }
      .cmd-table .col-desc { min-width: 180px; }
      .cmd-table .col-tags { min-width: 100px; }
      .cmd-table .col-date { width: 130px; white-space: nowrap; }
      .cmd-table .col-actions { width: 180px; white-space: nowrap; }
    </style>

  <table class="table table-striped table-hover cmd-table">
    <thead class="table-dark">
      <tr>
        <th class="col-arrow"></th>
        <th class="col-cmd">
          <i class="bi bi-terminal me-1"></i>Command
        </th>
        <th class="col-desc"><i class="bi bi-card-text me-1"></i>Description</th>
        <th class="col-tags"><i class="bi bi-tags me-1"></i>Tags</th>
        <th class="col-date"><i class="bi bi-calendar me-1"></i>Date</th>
        <th class="col-actions"><i class="bi bi-gear me-1"></i>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for cmd in commands %}
        <tr>
          <!-- Arrow -->
          <td><span class="expand-arrow">▶</span></td>

          <!-- Command – title when expanded -->
          <td class="cmd-cell">
            <div class="cmd-wrapper" title="{{ cmd.command }}">
              <span class="truncate-2 font-monospace">{{ cmd.command }}</span>
            </div>
          </td>

          <!-- Description – now keeps paragraphs & spaces -->
          <td class="desc-cell">
            <div class="description-text truncate-2" title="{{ cmd.description or '' }}">{{ cmd.description or "" }}</div>
          </td>

          <td>
            <div class="truncate-1" title="{{ cmd.tags or '' }}">{{ cmd.tags or "" }}</div>
          </td>

          <td class="text-nowrap">{{ cmd.created_at.strftime('%Y-%m-%d %H:%M') }}</td>

          <!-- Actions: Copy, Edit, Delete -->
          <td class="text-nowrap">
            <button type="button" class="btn btn-sm btn-outline-primary copy-btn me-1"
                    data-command="{{ cmd.command|e }}" aria-label="Copy command" title="Copy">
              <i class="bi bi-clipboard"></i>
            </button>
            <a href="{{ url_for('edit', cmd_id=cmd.id) }}"
               class="btn btn-sm btn-outline-secondary me-1" title="Edit">
              <i class="bi bi-pencil"></i>
            </a>
            <form action="{{ url_for('delete', cmd_id=cmd.id) }}"
                  method="post" style="display:inline;">
              <button type="submit"
                      class="btn btn-sm btn-outline-danger" title="Delete"
                      onclick="return confirm('Delete this command?');">
                <i class="bi bi-trash"></i>
              </button>
            </form>
          </td>
        </tr>
      {% endfor %}
    </tbody>
  </table>

  <div class="d-flex flex-wrap gap-2 mb-3 align-items-center">
    <span class="badge bg-success fs-6">
      <i class="bi bi-collection me-1"></i>{{ total_commands }} Commands
    </span>
    <span class="badge bg-dark fs-6">
      <i class="bi bi-tags me-1"></i>{{ total_tags|join(', ') or 'No tags' }}
    </span>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // ---------- copy helper ----------
      function copyText(text) {
        if (!text) return Promise.reject(new Error('No text to copy'));
        if (navigator.clipboard && navigator.clipboard.writeText) {
          return navigator.clipboard.writeText(text);
        }
        var ta = document.createElement('textarea');
        ta.value = text;
        ta.setAttribute('readonly', '');
        ta.style.position = 'absolute';
        ta.style.left = '-9999px';
        document.body.appendChild(ta);
        ta.select();
        try {
          var ok = document.execCommand('copy');
          document.body.removeChild(ta);
          return ok ? Promise.resolve() : Promise.reject(new Error('copy failed'));
        } catch (e) {
          document.body.removeChild(ta);
          return Promise.reject(e);
        }
      }

      // ---------- row‑click expand ----------
      document.querySelectorAll('tbody tr').forEach(function (row) {
        row.addEventListener('click', function (e) {
          if (e.target.closest('.copy-btn') || e.target.closest('form')) return;

          row.classList.toggle('expanded');

          // Adjust colspan of the description cell when expanded
          const descCell = row.querySelector('.desc-cell');
          if (row.classList.contains('expanded')) {
            descCell.setAttribute('colspan', '5');
          } else {
            descCell.removeAttribute('colspan');
          }
        });
      });

      // ---------- copy button ----------
      document.querySelectorAll('.copy-btn').forEach(function (btn) {
        btn.addEventListener('click', function (ev) {
          ev.stopPropagation();
          var text = btn.dataset.command || '';
          var icon = btn.querySelector('i');
          copyText(text).then(function () {
            icon.className = 'bi bi-check-lg';
            btn.classList.remove('btn-outline-primary');
            btn.classList.add('btn-success');
            setTimeout(function() {
              icon.className = 'bi bi-clipboard';
              btn.classList.remove('btn-success');
              btn.classList.add('btn-outline-primary');
            }, 1500);
          }).catch(function () {
            icon.className = 'bi bi-x-lg';
            btn.classList.remove('btn-outline-primary');
            btn.classList.add('btn-danger');
            setTimeout(function() {
              icon.className = 'bi bi-clipboard';
              btn.classList.remove('btn-danger');
              btn.classList.add('btn-outline-primary');
            }, 1500);
          });
        });
      });
    });
  </script>

  <!-- Pagination -->
  <nav aria-label="Page navigation" class="mt-4">
    <ul class="pagination justify-content-center">
      {% if page > 1 %}
        <li class="page-item">
          <a class="page-link" href="{{ url_for('index', page=page-1, search=search, per_page=per_page|default(5), sort_by=sort_by|default(''), sort_dir=sort_dir|default('desc')) }}" aria-label="Previous">
            <i class="bi bi-chevron-left"></i> Previous
          </a>
        </li>
      {% else %}
        <li class="page-item disabled"><span class="page-link"><i class="bi bi-chevron-left"></i> Previous</span></li>
      {% endif %}

      {% for p in range(1, total_pages + 1) %}
        <li class="page-item {% if p == page %}active{% endif %}">
          <a class="page-link" href="{{ url_for('index', page=p, search=search, per_page=per_page|default(5), sort_by=sort_by|default(''), sort_dir=sort_dir|default('desc')) }}">{{ p }}</a>
        </li>
      {% endfor %}

      {% if page < total_pages %}
        <li class="page-item">
          <a class="page-link" href="{{ url_for('index', page=page+1, search=search, per_page=per_page|default(5), sort_by=sort_by|default(''), sort_dir=sort_dir|default('desc')) }}" aria-label="Next">
            Next <i class="bi bi-chevron-right"></i>
          </a>
        </li>
      {% else %}
        <li class="page-item disabled"><span class="page-link">Next <i class="bi bi-chevron-right"></i></span></li>
      {% endif %}
    </ul>
  </nav>

{% else %}
  <div class="card shadow-sm">
    <div class="card-body text-center py-5">
      <i class="bi bi-inbox display-1 text-muted mb-3"></i>
      <h4 class="text-muted">No commands found</h4>
      <p class="text-muted mb-3">Get started by adding your first command!</p>
      <a href="{{ url_for('add') }}" class="btn btn-primary">
        <i class="bi bi-plus-lg me-1"></i>Add First Command
      </a>
    </div>
  </div>
{% endif %}
{% endblock %}