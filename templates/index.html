{% extends "layout.html" %}
{% block content %}
<h1 class="mb-3">All Commands</h1>

<form class="row g-3 mb-4" method="get" action="{{ url_for('index') }}">
  <div class="col-auto">
    <input type="text" name="search" class="form-control" placeholder="Search…" value="{{ search }}" list="tag-suggestions">
  </div>
  <datalist id="tag-suggestions">
    {% for tag in total_tags %}
      <option value="{{ tag }}">{{ tag }}</option>
    {% endfor %}
  </datalist>
  <div class="col-auto">
    <select name="per_page" class="form-select" onchange="this.form.submit()">
      <option value="5" {% if per_page|default(5)|int == 5 %}selected{% endif %}>5 rows</option>
      <option value="25" {% if per_page|default(5)|int == 25 %}selected{% endif %}>25 rows</option>
      <option value="50" {% if per_page|default(5)|int == 50 %}selected{% endif %}>50 rows</option>
      <option value="100" {% if per_page|default(5)|int == 100 %}selected{% endif %}>100 rows</option>
    </select>
  </div>
  <div class="col-auto">
    <button type="submit" class="btn btn-primary mb-3">Search</button>
  </div>
</form>

{% if commands %}
  <style>
      /* ---------- truncation utilities (unchanged) ---------- */
      .truncate-1,
      .truncate-2,
      .truncate-3 {
        display: block;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .truncate-1 { white-space: nowrap; }
      @supports (-webkit-line-clamp: 2) {
        .truncate-1 { white-space: normal; display: -webkit-box; line-clamp: 1; -webkit-line-clamp: 1; -webkit-box-orient: vertical; }
        .truncate-2 { display: -webkit-box; line-clamp: 2; -webkit-line-clamp: 2; -webkit-box-orient: vertical; }
        .truncate-3 { display: -webkit-box; line-clamp: 3; -webkit-line-clamp: 3; -webkit-box-orient: vertical; }
      }

      /* ---------- expanded row – remove truncation ---------- */
      tr.expanded .truncate-1,
      tr.expanded .truncate-2,
      tr.expanded .truncate-3 {
        white-space: normal !important;
        overflow: visible !important;
        text-overflow: unset !important;
        display: block !important;
        line-clamp: unset !important;
        -webkit-line-clamp: unset !important;
      }

      /* ---------- arrow indicator ---------- */
      .expand-arrow {
        display: inline-block;
        transition: transform 0.2s ease;
        font-size: 0.9rem;
        margin-right: 0.4rem;
      }
      tr.expanded .expand-arrow { transform: rotate(90deg); }

      /* ---------- command cell becomes a title when expanded ---------- */
      .cmd-cell .cmd-text { font-family: monospace; }
      tr.expanded .cmd-cell .cmd-text {
        font-size: 1.2rem;
        font-weight: 600;
        display: block;
        margin-bottom: 0.4rem;
      }

      /* ---------- hide the other columns when expanded ---------- */
      tr.expanded td:not(.cmd-cell):not(.desc-cell):not(:first-child) {
        display: none;
      }

      /* ---------- description cell takes full width when expanded ---------- */
      tr.expanded .desc-cell {
        display: table-cell;
        width: 100%;
        padding-top: 0.4rem;
      }

      /* ---------- keep paragraphs & spaces in description ---------- */
      .description-text {
        white-space: pre-wrap;   /* preserves line‑breaks & multiple spaces */
        font-family: inherit;     /* keep same font as surrounding text */
        margin: 0;               /* remove default <pre> margin */
      }

      /* NEW: keep pre‑wrap even when the row is expanded */
      tr.expanded .description-text {
        white-space: pre-wrap !important;
      }

      /* ---------- copy button (unchanged) ---------- */
      .copy-btn {
        opacity: 0.9;
        transition: opacity 0.12s ease;
      }
      @media (max-width: 480px) {
        .copy-btn { opacity: 0.8; font-size: 0.72rem; padding: 0.2rem 0.4rem; }
      }
    </style>

  <table class="table table-striped">
    <thead>
      <tr>
        <th style="width: 2%;"></th>
        <th style="width: 32%;">Command</th>
        <th>Description</th>
        <th>Tags</th>
        <th>Date</th>
        <th>Copy</th>
        <th></th>
      </tr>
    </thead>
    <tbody>
      {% for cmd in commands %}
        <tr>
          <!-- Arrow -->
          <td><span class="expand-arrow">▶</span></td>

          <!-- Command – title when expanded -->
          <td class="cmd-cell">
            <div class="cmd-wrapper" title="{{ cmd.command }}">
              <span class="truncate-1">{{ cmd.command }}</span>
            </div>
          </td>

          <!-- Description – now keeps paragraphs & spaces -->
          <td class="desc-cell">
            <div class="description-text truncate-2" title="{{ cmd.description or '' }}">{{ cmd.description or "" }}</div>
          </td>

          <td>
            <div class="truncate-1" title="{{ cmd.tags or '' }}">{{ cmd.tags or "" }}</div>
          </td>

          <td class="text-nowrap">{{ cmd.created_at.strftime('%Y-%m-%d %H:%M') }}</td>

          <td>
            <button type="button" class="btn btn-sm btn-outline-secondary copy-btn"
                    data-command="{{ cmd.command|e }}" aria-label="Copy command">Copy</button>
          </td>

          <td>
            <a href="{{ url_for('edit', cmd_id=cmd.id) }}"
               class="btn btn-sm btn-outline-secondary btn-action">Edit</a>

            <form action="{{ url_for('delete', cmd_id=cmd.id) }}"
                  method="post" style="display:inline;">
              <button type="submit"
                      class="btn btn-sm btn-outline-danger btn-action"
                      onclick="return confirm('Delete this command?');">Delete</button>
            </form>
          </td>
        </tr>
      {% endfor %}
    </tbody>
  </table>

  <div class="mb-3">
    <span class="badge bg-success ms-9">Total Commands: {{ total_commands }}</span>
    <span class="badge bg-dark ms-9">Tags: {{ total_tags|join(', ') }}</span>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // ---------- copy helper ----------
      function copyText(text) {
        if (!text) return Promise.reject(new Error('No text to copy'));
        if (navigator.clipboard && navigator.clipboard.writeText) {
          return navigator.clipboard.writeText(text);
        }
        var ta = document.createElement('textarea');
        ta.value = text;
        ta.setAttribute('readonly', '');
        ta.style.position = 'absolute';
        ta.style.left = '-9999px';
        document.body.appendChild(ta);
        ta.select();
        try {
          var ok = document.execCommand('copy');
          document.body.removeChild(ta);
          return ok ? Promise.resolve() : Promise.reject(new Error('copy failed'));
        } catch (e) {
          document.body.removeChild(ta);
          return Promise.reject(e);
        }
      }

      // ---------- row‑click expand ----------
      document.querySelectorAll('tbody tr').forEach(function (row) {
        row.addEventListener('click', function (e) {
          if (e.target.closest('.copy-btn') || e.target.closest('form')) return;

          row.classList.toggle('expanded');

          // Adjust colspan of the description cell when expanded
          const descCell = row.querySelector('.desc-cell');
          if (row.classList.contains('expanded')) {
            descCell.setAttribute('colspan', '5');
          } else {
            descCell.removeAttribute('colspan');
          }
        });
      });

      // ---------- copy button ----------
      document.querySelectorAll('.copy-btn').forEach(function (btn) {
        btn.addEventListener('click', function (ev) {
          ev.stopPropagation();
          var text = btn.dataset.command || '';
          copyText(text).then(function () {
            var original = btn.textContent;
            btn.textContent = 'Copied';
            setTimeout(() => btn.textContent = original, 1200);
          }).catch(function () {
            var original = btn.textContent;
            btn.textContent = 'Failed';
            setTimeout(() => btn.textContent = original, 1200);
          });
        });
      });
    });
  </script>

  <!-- Pagination (unchanged) -->
  <nav aria-label="Page navigation">
    <ul class="pagination">
      {% if page > 1 %}
        <li class="page-item">
          <a class="page-link" href="{{ url_for('index', page=page-1, search=search, per_page=per_page|default(5), sort_by=sort_by|default(''), sort_dir=sort_dir|default('desc')) }}">Previous</a>
        </li>
      {% else %}
        <li class="page-item disabled"><span class="page-link">Previous</span></li>
      {% endif %}

      {% for p in range(1, total_pages + 1) %}
        <li class="page-item {% if p == page %}active{% endif %}">
          <a class="page-link" href="{{ url_for('index', page=p, search=search, per_page=per_page|default(5), sort_by=sort_by|default(''), sort_dir=sort_dir|default('desc')) }}">{{ p }}</a>
        </li>
      {% endfor %}

      {% if page < total_pages %}
        <li class="page-item">
          <a class="page-link" href="{{ url_for('index', page=page+1, search=search, per_page=per_page|default(5), sort_by=sort_by|default(''), sort_dir=sort_dir|default('desc')) }}">Next</a>
        </li>
      {% else %}
        <li class="page-item disabled"><span class="page-link">Next</span></li>
      {% endif %}
    </ul>
  </nav>

{% else %}
  <p>No commands found. <a href="{{ url_for('add') }}">Add the first one</a>.</p>
{% endif %}
{% endblock %}